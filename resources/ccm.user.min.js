/**
 * @overview <i>ccm</i> component for user authentication
 * @author Andr√© Kless <andre.kless@h-brs.de> 2015-2016
 * @copyright Copyright (c) 2015-2016 Bonn-Rhein-Sieg University of Applied Sciences
 * @license The MIT License (MIT)
 */
ccm.component({name:"user",config:{context:!0,html:[ccm.load,"./json/user_html.json"],lang:[ccm.instance,"./components/lang.js",{store:[ccm.store,"./json/user_lang.json"]}],sign_on:"hbrsinfkaul",text_login:"lang#login",text_login_title:"lang#login_title",text_logout:"lang#logout",text_logout_title:"lang#logout_title",text_username_title:"lang#username_title"},Instance:function(){function e(e){for(var t=0;t<l.length;t++)l[t](e)}var t,n=null,l=[],o=this;this.init=function(e){if(o.context){var n=ccm.context.find(o,"user");o.context=n&&n.context||n}t=o.sign_on,delete o.sign_on,e&&e()},this.render=function(e){function t(){l(),o.login(function(){o.render()})}function n(){l(),o.logout(function(){o.render()})}function l(){c.append(ccm.helper.html({tag:"span"})),ccm.helper.loading(c.find("> span:last"))}if(o.context)return o.context.render(e);var c=ccm.helper.element(o);c.html(o.isLoggedIn()?ccm.helper.html(o.html.logged_in,ccm.helper.val(o.data().key,"key"),ccm.helper.val(o.text_username_title),ccm.helper.val(o.text_logout),n,ccm.helper.val(o.text_logout_title)):ccm.helper.html(o.html.logged_out,ccm.helper.val(o.text_login),t,ccm.helper.val(o.text_login_title))),o.lang&&o.lang.render(),e&&e()},this.login=function(l){function c(t,c,i,r){n={key:t,token:c,name:i,email:r},ccm.helper.tagExists(o.element.find("> #"+ccm.helper.getElementID(o)))&&o.render(),l&&l(),e(!0)}if(o.context)return o.context.login(l);if(o.isLoggedIn()&&l)return l();switch(t){case"demo":ccm.load(["https://kaul.inf.h-brs.de/login/demo_login.php",{realm:"hbrsinfkaul"}],function(e){c(e.user,e.token,e.user)});break;case"hbrsinfkaul":ccm.load(["https://kaul.inf.h-brs.de/login/login.php",{realm:"hbrsinfkaul"}],function(e){c(e.user,e.token,e.name,e.email)})}},this.logout=function(l){function c(){n=null,ccm.helper.tagExists(o.element.find("> #"+ccm.helper.getElementID(o)))&&o.render(),l&&l(),e(!1)}if(o.context)return o.context.logout(l);if(!o.isLoggedIn())return l();switch(t){case"demo":ccm.load(["https://logout@kaul.inf.h-brs.de/login/demo_logout.php",{realm:"hbrsinfkaul"}]),c();break;case"hbrsinfkaul":ccm.load(["https://logout@kaul.inf.h-brs.de/login/logout.php",{realm:"hbrsinfkaul"}]),c()}},this.isLoggedIn=function(){return o.context?o.context.isLoggedIn():!!n&&n.key},this.data=function(){return o.context?o.context.data():n},this.addObserver=function(e){return o.context?o.context.addObserver(e):void l.push(e)}}});